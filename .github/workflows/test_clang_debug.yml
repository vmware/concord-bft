name: Test (Debug, clang)
on:
  workflow_run:
    workflows: ["Build (Debug, clang)"]
    branches: [master]
    types:
      - completed

jobs:
  build:
    name: Test
    runs-on: ubuntu-18.04
    outputs:
      err_output: ${{ steps.prepare_err_artifacts.outputs.test}}
    strategy:
        fail-fast: false
        matrix:
            compiler:
                - "CONCORD_BFT_CONTAINER_CC=clang CONCORD_BFT_CONTAINER_CXX=clang++"
            ci_build_type:
                - "-DCMAKE_BUILD_TYPE=Debug -DBUILD_COMM_TCP_TLS=FALSE"
                - "-DCMAKE_BUILD_TYPE=Debug -DBUILD_COMM_TCP_TLS=TRUE"
            use_s3_obj_store:
                - "-DUSE_S3_OBJECT_STORE=ON"
                - "-DUSE_S3_OBJECT_STORE=OFF"
    steps:
        - name: Cleanup pre-installed tools
          run: |
            # This is a fix for https://github.com/actions/virtual-environments/issues/1918
            sudo rm -rf /usr/share/dotnet
            sudo rm -rf /opt/ghc
            sudo rm -rf "/usr/local/share/boost"
            sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        - name: Checkout
          uses: actions/checkout@v2
        - name: Create artifact directory
          run: mkdir -p ${{ github.workspace }}/artifact
        - name: Docker Pull
          run: |
              script -q -e -c "make pull"
        - name: Download Build artifact
          uses: dawidd6/action-download-artifact@v2
          with:
            github_token: ${{ secrets.GITHUB_TOKEN }}
            workflow: build_clang_debug.yml
            run_id: ${{ github.event.workflow_run.id }}
        #- name: Configure core dump location
        #  run: |
            # Uncomment the line below to enable core dump collection
            # echo "/concord-bft/build/cores/core.%e.%p" | sudo tee /proc/sys/kernel/core_pattern
            # Uncomment this is you want to login into the running session.
            # Please note that the build will block on this step.
            # Refer to https://github.com/marketplace/actions/debugging-with-tmate
        #- name: Setup tmate session
        #  uses: mxschmitt/action-tmate@v2
        - name: Test
          run: |
              script -q -e -c "ls -l"
              script -q -e -c "cat ./wat.txt"
              script -q -e -c "ls -l"
              sudo df -h
        #- name: Test
        #  run: |
        #      script -q -e -c "make pull"
        #      sudo df -h
        #      script -q -e -c "APOLLO_LOG_STDOUT=1 make TEST_NAME=skvbc_commit_path_tests single-test"
        - name: Prepare artifacts
          if: failure()
          run: |
            sudo chown -R ${USER}:${GROUP} ${PWD}/build
            tar -czvf ${{ github.workspace }}/artifact/logs.tar.gz ./build/tests/apollo/logs
            du -h ${{ github.workspace }}/artifact
            sudo df -h
        - name: Upload artifacts
          uses: actions/upload-artifact@v2
          if: failure()
          with:
            name: artifacts-${{ matrix.compiler }}-${{ matrix.ci_build_type }}-${{ github.sha }}
            path: ${{ github.workspace }}/artifact/
        - name: Check ERROR/FATAL logs
          if: always()
          run: |
            ./.github/success_action_if_err_logs_exist.sh ./build/tests/apollo/logs
            echo "file_count=$(find ./build/tests/apollo/logs -name ReplicaErrorLogs.txt | wc -l)" >> $GITHUB_ENV
        - name: Prepare error artifacts
          id: prepare_err_artifacts
          if: ${{ env.file_count > 0 }}
          run: |
            sudo chown -R ${USER}:${GROUP} ${PWD}/build
            tar -czvf ${{ github.workspace }}/artifact/logs.tar.gz ./build/tests/apollo/logs
            du -h ${{ github.workspace }}/artifact
            sudo df -h
            echo "::set-output name=test::success"
        - name: Upload error artifacts
          uses: actions/upload-artifact@v2
          if: ${{ env.file_count > 0 }}
          with:
            name: artifacts-${{ matrix.compiler }}-${{ matrix.ci_build_type }}-${{ github.sha }}
            path: ${{ github.workspace }}/artifact/

  runtest:
    name: Check ERROR/FATAL logs(Apollo)
    runs-on: ubuntu-18.04
    continue-on-error: true
    needs: build
    steps:
      - name: Check ERROR/FATAL logs in apollo
        if: needs.build.outputs.err_output == 'success'
        run: |
          echo "Errors exist in replica logs. Please check Artifacts"
          exit 1
  testlog:
    name: Check ERROR/FATAL logs(Apollo)
    runs-on: ubuntu-18.04
    continue-on-error: true
    needs: build
    steps:
        - name: Check ERROR/FATAL logs in apollo
          if: needs.build.outputs.err_output == 'success'
          run: |
            echo "Errors exist in replica logs. Please check Artifacts"
            exit 1

